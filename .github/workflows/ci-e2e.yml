name: CI - macOS llama runtime

on:
  push:
    branches: [main]
    paths:
      - .github/workflows/ci-e2e.yml
      - tests/runtime/**
      - src/prompts/**
      - src/tools/**
  pull_request:
    paths:
      - .github/workflows/ci-e2e.yml
      - tests/runtime/**
      - src/prompts/**
      - src/tools/**

env:
  MODEL_SPEC: bartowski/SmolLM2-135M-Instruct-GGUF:SmolLM2-135M-Instruct-Q4_K_M.gguf
  MODEL_BRANCH: main
  LLAMA_BIN: llama-cli
  APPROVE_ALL: true
  USE_REACT_LLAMA: true
  HF_HOME: /Users/runner/Library/Caches/huggingface

jobs:
  macos-runtime:
    runs-on: macos-latest
    timeout-minutes: 60
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Homebrew dependencies
        timeout-minutes: 15
        shell: bash
        run: |
          set -euxo pipefail
          brew update
          brew install cmake pkg-config python jq coreutils git-lfs bats-core llama.cpp

      - name: Run macOS llama runtime test
        timeout-minutes: 15
        shell: bash
        env:
          MODEL_SPEC: ${{ env.MODEL_SPEC }}
          MODEL_BRANCH: ${{ env.MODEL_BRANCH }}
        run: |
          set -euxo pipefail
          bats --print-output-on-failure tests/runtime/test_macos_tiny_llama.sh