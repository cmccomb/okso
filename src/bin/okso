#!/usr/bin/env bash
# shellcheck disable=SC2034
#
# Entrypoint for the local assistant harness.
#
# Usage:
#   ./src/bin/okso [OPTIONS] -- "user query"
#
# Options:
#   -h, --help            Show help text.
#   -V, --version         Show version information.
#   -y, --yes, --no-confirm
#                         Approve all tool runs without prompting.
#       --confirm         Always prompt before running tools.
#       --dry-run         Print the planned tool calls without running them.
#       --plan-only       Emit the planned calls as JSON and exit.
#   -m, --model VALUE     HF repo[:file] for llama.cpp download (default: bartowski/Qwen_Qwen3-4B-GGUF:Qwen_Qwen3-4B-Q4_K_M.gguf).
#       --model-branch BRANCH  HF branch or tag for the model download (default: main).
#       --config FILE     Config file to load (default: ${XDG_CONFIG_HOME:-$HOME/.config}/okso/config.env).
#   -v, --verbose         Increase log verbosity (JSON logs are always structured).
#   -q, --quiet           Silence informational logs.
#
# Environment:
#   LLAMA_BIN       llama.cpp binary (default: llama-cli).
#
# Dependencies:
#   - bash 3.2+ (matches the macOS system baseline)
#   - Optional: llama.cpp binary available on PATH for real scoring.
#   - Optional: fd, rg for faster search tooling.
#
# Exit codes:
#   0 on success, non-zero on argument or runtime errors.

# Enforce minimum bash version (3.2+) for macOS compatibility.
MIN_BASH_MAJOR=3
MIN_BASH_MINOR=2
MIN_BASH_VERSION_STRING="${MIN_BASH_MAJOR}.${MIN_BASH_MINOR}"
if [[ -n "${OKSO_BASH_VERSION_OVERRIDE:-}" ]]; then
	if [[ "${OKSO_BASH_VERSION_OVERRIDE}" =~ ^([0-9]+)\.([0-9]+) ]]; then
		current_bash_major="${BASH_REMATCH[1]}"
		current_bash_minor="${BASH_REMATCH[2]}"
	else
		printf 'okso requires a parsable bash version override (expected MAJOR.MINOR); received "%s".\n' "${OKSO_BASH_VERSION_OVERRIDE}" >&2
		exit 1
	fi
else
	if [[ -z "${BASH_VERSINFO[0]:-}" || -z "${BASH_VERSINFO[1]:-}" ]]; then
		printf 'okso requires bash %s or newer (documented baseline for macOS); unable to detect the current shell version.\n' "${MIN_BASH_VERSION_STRING}" >&2
		exit 1
	fi

	current_bash_major="${BASH_VERSINFO[0]}"
	current_bash_minor="${BASH_VERSINFO[1]}"
fi

# Compare versions and exit if the current bash is too old.
if ((current_bash_major < MIN_BASH_MAJOR || (current_bash_major == MIN_BASH_MAJOR && current_bash_minor < MIN_BASH_MINOR))); then
	printf 'okso requires bash %s or newer (documented baseline for macOS system shells); detected %s.%s. Please upgrade bash or run with the supported version.\n' "${MIN_BASH_VERSION_STRING}" "${current_bash_major}" "${current_bash_minor}" >&2
	exit 1
fi

set -euo pipefail

resolve_script_dir() {
	local source_path source_dir
	source_path="${BASH_SOURCE[0]}"

	while [ -h "${source_path}" ]; do
		source_dir=$(cd -P -- "$(dirname -- "${source_path}")" && pwd)
		source_path=$(readlink "${source_path}")
		if [[ "${source_path}" != /* ]]; then
			source_path="${source_dir}/${source_path}"
		fi
	done

	cd -P -- "$(dirname -- "${source_path}")" && pwd
}

SCRIPT_DIR=$(resolve_script_dir)
SRC_ROOT=$(cd "${SCRIPT_DIR}/.." && pwd)
LIB_DIR="${SRC_ROOT}/lib"
export OKSO_ENTRYPOINT="${OKSO_ENTRYPOINT:-./src/bin/okso}"

# shellcheck source=../lib/core/errors.sh disable=SC1091
source "${LIB_DIR}/core/errors.sh"
# shellcheck source=../lib/core/logging.sh disable=SC1091
source "${LIB_DIR}/core/logging.sh"
# shellcheck source=../lib/config.sh disable=SC1091
source "${LIB_DIR}/config.sh"
# shellcheck source=../lib/tools.sh disable=SC1091
source "${LIB_DIR}/tools.sh"
# shellcheck source=../lib/planning/planner.sh disable=SC1091
source "${LIB_DIR}/planning/planner.sh"
# shellcheck source=../lib/planning/respond.sh disable=SC1091
source "${LIB_DIR}/planning/respond.sh"
# shellcheck source=../lib/cli/cli.sh disable=SC1091
source "${LIB_DIR}/cli/cli.sh"
# shellcheck source=../lib/runtime.sh disable=SC1091
source "${LIB_DIR}/runtime.sh"

main() {
	local settings_prefix
	local plan_outline required_tools plan_entries plan_action plan_json

	settings_prefix="settings"

	load_runtime_settings "${settings_prefix}" "$@"

	if [[ "$(settings_get "${settings_prefix}" "command")" == "init" ]]; then
		# Init mode writes a config file and exits without running the planner.
		apply_settings_to_globals "${settings_prefix}"
		write_config_file
		return 0
	fi

	prepare_environment_with_settings "${settings_prefix}"
	# Planner flow:
	# 1. Generate an outline, 2. identify tools, 3. build concrete plan entries
	# for execution, then 4. render plan outputs before proceeding.
	log "INFO" "Starting plan generation" "$(settings_get "${settings_prefix}" "user_query")"
	plan_json="$(generate_plan_json "$(settings_get "${settings_prefix}" "user_query")")"
	plan_outline="$(plan_json_to_outline "${plan_json}")"
	required_tools="$(derive_allowed_tools_from_plan "${plan_json}")"
	log "INFO" "Planner identified tools" "${required_tools}"
	plan_entries="$(plan_json_to_entries "${plan_json}")"

	render_plan_outputs plan_action "${settings_prefix}" "${required_tools}" "${plan_entries}" "${plan_outline}"
	if [[ "${plan_action}" == "exit" ]]; then
		return 0
	fi

	select_response_strategy "${settings_prefix}" "${required_tools}" "${plan_entries}" "${plan_outline}"
}

main "$@"
